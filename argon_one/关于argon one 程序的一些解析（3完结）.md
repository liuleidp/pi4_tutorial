# 关于argon one 程序的一些解析（3完结）

在设计的时候，单树莓派执行了halt语句后。我们需要发送一个信号给单片机，让hat板上的单片机切断整个pi4的电源。这是如何做到的呢？



**/lib/systemd/system-shutdown/argononed-poweroff.py**

这个程序会在系统关闭前，自动运行。



### 整个控制流程的解析：

* 如果用按钮控制pi的重启、软关机、强行关闭

  > 按钮单击，打开pmos。让整个系统通电
  >
  > 按钮持续按5s+，关闭pmos。让整个系统断电
  >
  > 按钮双击，mcu输出一个0.03s高电平脉冲给pi。pi上的程序探测到脉冲，然后进行软件重启
  >
  > 按钮保持3s中。mcu输出一个0.05s的高电平脉冲给pi。pi进行软件关机。

* 用ssh关机，也需要关闭系统或者关闭风扇

  > 在系统里的特定目录下，利用系统的systemd功能，来实现自动运行脚本。脚本的目录是**/lib/systemd/system-shutdown/** 。脚本内可以判断是否是reboot，还是halt or poweroff。 最重要的是这个脚本是由系统在关机前自动调用的。所以才能实现通知mcu关闭pmos的功能。

* 智能调速

  > 一个常驻内存的python程序，每30s读取一下cpu的温度。然后根据温度发送风扇的转速值给MCU。（接口为iic总线）。MCU对iic进行解码，然后控制风扇的速度。
  >
  > 其中还有一个温度控制的配置表，存放在 **/etc/argonone.conf** ，这里控制的是温度，和对应温度的转速值。温度的排序最好是从高到低的排序。

  







